# ============================================
# ZSH Configuration
# Dalton Payne's dotfiles
# ============================================

# ┌─────────────────────────────────────────┐
# │ 1. Shell Options                        │
# └─────────────────────────────────────────┘

# History configuration
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000
setopt APPEND_HISTORY           # Append to history file
setopt SHARE_HISTORY            # Share history between sessions
setopt HIST_IGNORE_DUPS         # Don't record duplicates
setopt HIST_IGNORE_SPACE        # Don't record commands starting with space
setopt HIST_VERIFY              # Show command before executing from history

# Directory navigation
setopt AUTO_CD                  # cd by typing directory name
setopt AUTO_PUSHD               # Push directories onto stack
setopt PUSHD_IGNORE_DUPS        # Don't push duplicates
setopt PUSHD_SILENT             # Don't print directory stack

# Completion
setopt ALWAYS_TO_END            # Move cursor to end after completion
setopt AUTO_MENU                # Show completion menu on tab
setopt COMPLETE_IN_WORD         # Complete from both ends of word

# ┌─────────────────────────────────────────┐
# │ 2. Environment Variables                │
# └─────────────────────────────────────────┘

# Disable telemetry
export FUNCTIONS_CORE_TOOLS_TELEMETRY_OPTOUT=1

# ┌─────────────────────────────────────────┐
# │ 3. PATH Configuration                   │
# └─────────────────────────────────────────┘

# Local bin
export PATH="$HOME/.local/bin:$PATH"

# Python from Homebrew (if installed)
if command -v brew &> /dev/null; then
  export PATH="$(brew --prefix python)/libexec/bin:$PATH"
fi

# rbenv (must be early for PATH to work correctly)
if command -v rbenv &> /dev/null; then
  eval "$(rbenv init - zsh)"
fi

export PYENV_ROOT="$HOME/.pyenv"
export PATH="$PYENV_ROOT/bin:$PATH"
eval "$(pyenv init -)"
# ┌─────────────────────────────────────────┐
# │ 4. Completion System                    │
# └─────────────────────────────────────────┘

# Initialize completion system
autoload -Uz compinit
compinit

# Completion styling
zstyle ':completion:*' menu select                          # Use menu selection
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}'        # Case insensitive
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"    # Use LS_COLORS

# ┌─────────────────────────────────────────┐
# │ 5. Plugins (load order matters!)       │
# └─────────────────────────────────────────┘

# Load syntax highlighting (should be near the end of plugins)
if [[ -f /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]]; then
  source /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
fi

# Load autosuggestions
if [[ -f /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh ]]; then
  source /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh
fi

# fzf - must load BEFORE zsh-vi-mode to preserve keybindings
if command -v brew &> /dev/null; then
  if [[ -f "$(brew --prefix)/opt/fzf/shell/key-bindings.zsh" ]]; then
    source "$(brew --prefix)/opt/fzf/shell/key-bindings.zsh"
  fi
  if [[ -f "$(brew --prefix)/opt/fzf/shell/completion.zsh" ]]; then
    source "$(brew --prefix)/opt/fzf/shell/completion.zsh"
  fi
fi

# ┌─────────────────────────────────────────┐
# │ 6. zsh-vi-mode (MUST BE LAST PLUGIN)   │
# └─────────────────────────────────────────┘
# Note: This plugin aggressively overrides keybindings.
# Any keybindings set after this must use zvm_after_init()

# Define post-init function for vi-mode
function zvm_after_init() {
  # Tmux which-key integration (set AFTER vi-mode loads)
  if command -v tmux &> /dev/null; then
    tmux-which-key() { tmux show-wk-menu-root ; }
    zle -N tmux-which-key
    bindkey -M vicmd " " tmux-which-key
  fi
}

# Load zsh-vi-mode (LAST PLUGIN!)
if command -v brew &> /dev/null; then
  if [[ -f "$(brew --prefix)/opt/zsh-vi-mode/share/zsh-vi-mode/zsh-vi-mode.plugin.zsh" ]]; then
    source "$(brew --prefix)/opt/zsh-vi-mode/share/zsh-vi-mode/zsh-vi-mode.plugin.zsh"
  fi
fi

# ┌─────────────────────────────────────────┐
# │ 7. Aliases                              │
# └─────────────────────────────────────────┘

# ──────── Core Aliases (all machines) ────────
alias cl="clear"
alias v="nvim"
alias lg="lazygit"
alias q="logout"

# Zsh config shortcuts
alias ep="nvim ~/.zshrc"
alias sp="source ~/.zshrc"

# Python virtual environment
alias s="source .venv/bin/activate"
alias d="deactivate"

# Tmux
alias st="tmux source-file ~/.tmux.conf"

# Enhanced ls (only if lsd is installed)
if command -v lsd &> /dev/null; then
  alias ls="lsd -ltg"
fi

{{- if eq .machineType "personal" }}

# ──────── Personal Machine Aliases ────────
alias fav="cd ~/Favorites/"
alias lf="cd {{ .chezmoi.homeDir }}/Favorites/LIFE-iCloud"
alias jrnl='cd "{{ .chezmoi.homeDir }}/Library/Mobile Documents/com~apple~CloudDocs/iCloud/01-LIFE/20-29-Personal-Library/22 Personal Documents/22.01 Journal" && cl'

# Personal tools (conditional on installation)
command -v simplelogin &> /dev/null && alias sl="simplelogin"
command -v aicommits &> /dev/null && alias aic="aicommits"
command -v databricks &> /dev/null && alias db="databricks"

# NAPS2 scanner app
if [[ -f "/Applications/NAPS2.app/Contents/MacOS/NAPS2" ]]; then
  alias naps2="/Applications/NAPS2.app/Contents/MacOS/NAPS2 console"
fi
{{- end }}

{{- if eq .machineType "work" }}

# ──────── Work Machine Aliases ────────
# Add work-specific aliases here

{{- end }}

# ┌─────────────────────────────────────────┐
# │ 8. Functions                            │
# └─────────────────────────────────────────┘

# ──────── Enhanced cd with auto-ls ────────
# Automatically list directory contents after cd
cd() {
  builtin cd "$@" || return  # Exit if cd fails

  # Only ls if lsd is available, otherwise skip
  if command -v lsd &> /dev/null; then
    lsd -ltg
  else
    ls -lh
  fi
}

# ──────── Yazi file manager integration ────────
# Exit yazi and cd to the last directory
function y() {
  # Require yazi to be installed
  if ! command -v yazi &> /dev/null; then
    echo "Error: yazi is not installed"
    return 1
  fi

  local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
  yazi "$@" --cwd-file="$tmp"

  if IFS= read -r -d '' cwd < "$tmp" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
    builtin cd -- "$cwd"
  fi

  rm -f -- "$tmp"
}

# ──────── Aerospace window fuzzy finder ────────
# Use fzf to quickly switch between aerospace windows
ff() {
  if ! command -v aerospace &> /dev/null; then
    echo "Error: aerospace is not installed"
    return 1
  fi

  if ! command -v fzf &> /dev/null; then
    echo "Error: fzf is not installed"
    return 1
  fi

  aerospace list-windows --all | \
    fzf --bind 'enter:execute(aerospace focus --window-id {1})+abort'
}

# ┌─────────────────────────────────────────┐
# │ 9. Prompt & Additional Tools            │
# └─────────────────────────────────────────┘

# Starship prompt (load near end)
if command -v starship &> /dev/null; then
  eval "$(starship init zsh)"
fi

# Envman environment manager (if installed)
if [[ -s "$HOME/.config/envman/load.sh" ]]; then
  source "$HOME/.config/envman/load.sh"
fi

# ┌─────────────────────────────────────────┐
# │ End of Configuration                    │
# └─────────────────────────────────────────┘

